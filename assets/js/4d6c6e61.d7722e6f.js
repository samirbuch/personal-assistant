"use strict";(globalThis.webpackChunkpersonal_assistant_docs=globalThis.webpackChunkpersonal_assistant_docs||[]).push([[9698],{28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>o});var a=n(96540);const s={},i=a.createContext(s);function r(e){const t=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(i.Provider,{value:t},e.children)}},70507:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"system-design","title":"System Design","description":"There are multiple components working together to create the assistant. Our stack:","source":"@site/docs/system-design.md","sourceDirName":".","slug":"/system-design","permalink":"/personal-assistant/docs/system-design","draft":false,"unlisted":false,"editUrl":"https://github.com/samirbuch/personal-assistant/edit/main/docs/docs/system-design.md","tags":[],"version":"current","lastUpdatedBy":"bdotsamir","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"docsSidebar","previous":{"title":"Architecture Diagram","permalink":"/personal-assistant/docs/architecture-diagram"},"next":{"title":"Tutorial Intro","permalink":"/personal-assistant/docs/docusaurus-meta/intro"}}');var s=n(74848),i=n(28453);const r={sidebar_position:7},o="System Design",l={},c=[{value:"High-level overview",id:"high-level-overview",level:2},{value:"Sequence Diagram",id:"sequence-diagram",level:2}];function h(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Details:n}=t;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"system-design",children:"System Design"})}),"\n",(0,s.jsx)(t.p,{children:"There are multiple components working together to create the assistant. Our stack:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://www.twilio.com/en-us/voice",children:(0,s.jsx)(t.strong,{children:"Twilio"})})," - Phone service provider. Handles inbound and outbound calls."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://developers.deepgram.com/home",children:(0,s.jsx)(t.strong,{children:"Deepgram"})})," - Text-To-Speech (TTS) and Speech-To-Text (STT). We can stream it audio in 8khz \xb5law base64 format and it will stream back matching text, and vice versa streaming it text and it streams back 8khz \xb5law base64-encoded audio."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"LLM"})," - Whichever LLM we choose to use, I'm parital to ",(0,s.jsx)(t.a,{href:"https://www.anthropic.com/claude/haiku",children:"Claude Haiku"})," because of its simplicity, how fast it is, and how cheap it is per token."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Our server"})," - We'll be using ",(0,s.jsx)(t.a,{href:"https://bun.sh/",children:"Bun.js"})," for the runtime as the web server. Essentially all of the services report back to our server through Websockets which we can then process and route to where they need to go."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"high-level-overview",children:"High-level overview"}),"\n",(0,s.jsx)(t.p,{children:"The system works in a loop for the most part. Twilio first initiates the outbound call to, for example, a barbershop."}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:'A person picks up the phone and says "Hello?"'}),"\n",(0,s.jsxs)(t.li,{children:["That audio data is then ",(0,s.jsx)(t.strong,{children:"streamed"})," via a websocket to our server,"]}),"\n",(0,s.jsxs)(t.li,{children:["which ",(0,s.jsx)(t.strong,{children:"streams"})," it right back out to Deepgram STT."]}),"\n",(0,s.jsxs)(t.li,{children:["Deepgram then ",(0,s.jsx)(t.strong,{children:"streams"})," the text back to our server, which stores it in a conversation history."]}),"\n",(0,s.jsx)(t.li,{children:"Our server then sends the conversation history to the LLM to generate a response"}),"\n",(0,s.jsxs)(t.li,{children:["The LLM ",(0,s.jsx)(t.strong,{children:"streams"})," tokens back to the server"]}),"\n",(0,s.jsxs)(t.li,{children:["The server ",(0,s.jsx)(t.strong,{children:"streams"})," those tokens to Deepgram TTS"]}),"\n",(0,s.jsxs)(t.li,{children:["Deepgram ",(0,s.jsx)(t.strong,{children:"streams"})," the audio data back to our server"]}),"\n",(0,s.jsxs)(t.li,{children:["Our server ",(0,s.jsx)(t.strong,{children:"streams"})," the audio back to Twilio, which relays it back to the Barbershop."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Most things about this system are happening asynchronously via streams to reduce roundtrip latency (Barbershop request -> Response). We're aiming for <100ms roundtrip."}),"\n",(0,s.jsxs)(t.p,{children:["Occasionally the LLM will make calls to external ",(0,s.jsx)(t.strong,{children:"tools"}),". Luckily, this is fairly easy to implement thanks to the package we'll be using to handle LLM requests: ",(0,s.jsx)(t.a,{href:"https://npmjs.com/package/ai",children:(0,s.jsx)(t.code,{children:"ai"})})," by Vercel."]}),"\n",(0,s.jsx)(t.h2,{id:"sequence-diagram",children:"Sequence Diagram"}),"\n",(0,s.jsx)(t.mermaid,{value:'sequenceDiagram\n    actor User\n    participant Website\n    participant Database\n    participant Server\n    actor Barbershop\n\n    User ->> Website: "Schedule a haircut please"\n    activate Website\n    Website ->> Database: "Queue this appointment please"\n    Database --\x3e> Website: "Done"\n    Website --\x3e> User: "Got it, it\'s queued up."\n    deactivate Website\n\n    Server -) Database: "Are there any appointments to make?"\n    activate Database\n    Database --\x3e> Server: "Yes! Please make this appointment now"\n    deactivate Database\n\n    loop Scheduling conversation\n    Server ->> Barbershop: "[LLM]: Schedule appointment"\n    Barbershop --\x3e> Server: "Cool, scheduled."\n    end\n\n    Server ->> Database: Update status\n\n    User ->> Website: Check appointments\n    activate Website\n    Website ->> Database: Check appointments\n    Database --\x3e> Website: Upcoming appointments\n    Website --\x3e> User: Upcoming appointments\n    deactivate Website\n\n    User ->> Barbershop: Get haircut'}),"\n",(0,s.jsxs)(n,{children:[(0,s.jsx)("summary",{children:"Technical seq diagram of server machinations"}),(0,s.jsx)(t.mermaid,{value:'sequenceDiagram\n    actor User\n    participant Client\n    participant S as Server/Daemon\n    actor Twilio\n    actor Barbershop\n    actor Deepgram\n    actor LLM\n    actor Calendar as Outlook Calendar\n\n    User ->> Client: "Schedule a haircut please"\n    Client ->> S: POST /api/new\n    S --\x3e> Client: 200 OK\n    Client --\x3e> User: "Request scheduled!"\n\n    activate S\n    S ->> S: Wait for business hours\n    deactivate S\n\n    S ->> Twilio: Initiate outbound call\n    activate S\n    activate Twilio\n\n    Twilio ->> Barbershop: Call barbershop\n    activate Barbershop\n\n    loop Conversation and negotiation\n        Barbershop --) Twilio: "Hello?"\n        Twilio --) S: audio/x-mulaw 8khz stream\n        S -) Deepgram: audio/x-mulaw 8khz\n        activate Deepgram\n        Deepgram --) S: Speech-To-Text (STT) "Hello?"\n        deactivate Deepgram\n\n        S -) LLM: Conversation\n        LLM --) S: Response "Hi! I\'d like to schedule a haircut for Samir please"\n        S -) Deepgram: Text-To-Speech (TTS) Response\n        activate Deepgram\n        Deepgram --) S: audio/x-mulaw 8khz stream\n        deactivate Deepgram\n\n        S -) Twilio: audio/x-mulaw 8khz stream\n        Twilio -) Barbershop: "Hi! I\'d like to..."\n\n    opt Getting availability for User\n        S -) LLM: Conversation\n\n        activate LLM\n        LLM ->> Calendar: (TOOL) Get availability\n        activate Calendar\n        Calendar ->> LLM: Return availability\n        deactivate Calendar\n        LLM --\x3e> S: "I have availability for this time"\n        deactivate LLM\n    %% Opt\n    end\n\n    %% Loop\n    end \n    activate LLM\n    LLM -) Twilio: (TOOL) End call\n    deactivate Twilio\n    deactivate Barbershop\n\n    LLM ->> Calendar: (TOOL) Create event\n    activate Calendar\n    Calendar --\x3e> LLM: Event Details\n    deactivate Calendar\n    LLM --\x3e> S: Event created\n    deactivate LLM\n\n    S --\x3e> Client: Show event to user\n    deactivate S\n\n    User ->> Barbershop: Show up for appointment'})]})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);