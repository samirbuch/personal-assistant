"use strict";(globalThis.webpackChunkpersonal_assistant_docs=globalThis.webpackChunkpersonal_assistant_docs||[]).push([[6931],{28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>o});var s=i(96540);const r={},t=s.createContext(r);function l(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(t.Provider,{value:n},e.children)}},76741:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"generated/PROJECT_STRUCTURE","title":"Project Structure - Voice Agent Architecture","description":"This project is a complete rewrite with a clean, event-driven architecture for handling phone-based AI voice conversations with instant interruption support.","source":"@site/docs/generated/PROJECT_STRUCTURE.md","sourceDirName":"generated","slug":"/generated/PROJECT_STRUCTURE","permalink":"/personal-assistant/docs/generated/PROJECT_STRUCTURE","draft":false,"unlisted":false,"editUrl":"https://github.com/samirbuch/personal-assistant/edit/main/docs/docs/generated/PROJECT_STRUCTURE.md","tags":[],"version":"current","lastUpdatedBy":"bdotsamir","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Outlook Calendar Integration Setup (Simple iCal Method)","permalink":"/personal-assistant/docs/generated/OUTLOOK_SETUP"},"next":{"title":"Introduction","permalink":"/personal-assistant/docs/imported/intro"}}');var r=i(74848),t=i(28453);const l={},o="Project Structure - Voice Agent Architecture",c={},a=[{value:"\ud83c\udfd7\ufe0f File Structure",id:"\ufe0f-file-structure",level:2},{value:"\ud83d\udccb Component Responsibilities",id:"-component-responsibilities",level:2},{value:"<strong>Core Components</strong>",id:"core-components",level:3},{value:"<code>VoiceAgent.ts</code> - Main Orchestrator",id:"voiceagentts---main-orchestrator",level:4},{value:"<code>StateMachine.ts</code> - State Management",id:"statemachinets---state-management",level:4},{value:"<code>AudioController.ts</code> - Audio Gate",id:"audiocontrollerts---audio-gate",level:4},{value:"<code>InterruptionDetector.ts</code> - Smart Detection",id:"interruptiondetectorts---smart-detection",level:4},{value:"<code>ConversationManager.ts</code> - Context Management",id:"conversationmanagerts---context-management",level:4},{value:"<strong>Managers</strong>",id:"managers",level:3},{value:"<code>SessionManager.ts</code> - Session Lifecycle",id:"sessionmanagerts---session-lifecycle",level:4},{value:"<code>DeepgramManager.ts</code> - Deepgram Integration",id:"deepgrammanagerts---deepgram-integration",level:4},{value:"<code>LLMManager.ts</code> - Claude Integration",id:"llmmanagerts---claude-integration",level:4},{value:"<strong>Handlers</strong>",id:"handlers",level:3},{value:"<code>TwilioHandler.ts</code> - Twilio Integration",id:"twiliohandlerts---twilio-integration",level:4},{value:"<strong>Main Entry Point</strong>",id:"main-entry-point",level:3},{value:"<code>index.ts</code> - Bun Server",id:"indexts---bun-server",level:4},{value:"\ud83d\udd04 Data Flow",id:"-data-flow",level:2},{value:"Normal Conversation Flow",id:"normal-conversation-flow",level:3},{value:"Interruption Flow",id:"interruption-flow",level:3},{value:"\ud83c\udfaf Key Architectural Decisions",id:"-key-architectural-decisions",level:2},{value:"1. <strong>State Machine Over Flags</strong>",id:"1-state-machine-over-flags",level:3},{value:"2. <strong>Audio Gate Pattern</strong>",id:"2-audio-gate-pattern",level:3},{value:"3. <strong>Connection Pooling</strong>",id:"3-connection-pooling",level:3},{value:"4. <strong>Event-Driven Architecture</strong>",id:"4-event-driven-architecture",level:3},{value:"5. <strong>Separation of Concerns</strong>",id:"5-separation-of-concerns",level:3},{value:"\ud83d\ude80 Performance Optimizations",id:"-performance-optimizations",level:2},{value:"\ud83d\udee0\ufe0f Future Extensibility",id:"\ufe0f-future-extensibility",level:2},{value:"\ud83d\udcdd Configuration",id:"-configuration",level:2},{value:"\ud83e\uddea Testing Strategy",id:"-testing-strategy",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"project-structure---voice-agent-architecture",children:"Project Structure - Voice Agent Architecture"})}),"\n",(0,r.jsx)(n.p,{children:"This project is a complete rewrite with a clean, event-driven architecture for handling phone-based AI voice conversations with instant interruption support."}),"\n",(0,r.jsx)(n.h2,{id:"\ufe0f-file-structure",children:"\ud83c\udfd7\ufe0f File Structure"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"src/\n\u251c\u2500\u2500 index.ts                                # Main Bun server entry point\n\u2502\n\u251c\u2500\u2500 core/                                   # Core business logic components\n\u2502   \u251c\u2500\u2500 VoiceAgent.ts                      # Main orchestrator - coordinates all components\n\u2502   \u251c\u2500\u2500 StateMachine.ts                    # State management (IDLE \u2192 LISTENING \u2192 SPEAKING \u2192 INTERRUPTING)\n\u2502   \u251c\u2500\u2500 AudioController.ts                 # Audio gate with instant on/off control\n\u2502   \u251c\u2500\u2500 InterruptionDetector.ts            # Smart interruption detection with adaptive thresholds\n\u2502   \u2514\u2500\u2500 ConversationManager.ts             # Conversation history and context management\n\u2502\n\u251c\u2500\u2500 managers/                               # Service managers\n\u2502   \u251c\u2500\u2500 SessionManager.ts                  # Session lifecycle and cleanup\n\u2502   \u251c\u2500\u2500 DeepgramManager.ts                 # Deepgram STT/TTS with connection pooling\n\u2502   \u2514\u2500\u2500 LLMManager.ts                      # Claude streaming with abort handling\n\u2502\n\u2514\u2500\u2500 handlers/                               # External service handlers\n    \u2514\u2500\u2500 TwilioHandler.ts                   # Twilio WebSocket message handling\n"})}),"\n",(0,r.jsx)(n.h2,{id:"-component-responsibilities",children:"\ud83d\udccb Component Responsibilities"}),"\n",(0,r.jsx)(n.h3,{id:"core-components",children:(0,r.jsx)(n.strong,{children:"Core Components"})}),"\n",(0,r.jsxs)(n.h4,{id:"voiceagentts---main-orchestrator",children:[(0,r.jsx)(n.code,{children:"VoiceAgent.ts"})," - Main Orchestrator"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Coordinates all components and manages the voice agent lifecycle"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Methods:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"handleIncomingAudio(audio)"})," - Process incoming user audio"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"handleTranscript(text)"})," - Process user transcripts"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generateResponse()"})," - Generate and stream LLM responses"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"interrupt()"})," - Handle interruptions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cleanup()"})," - Clean shutdown"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Responsibilities:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Coordinates between all managers and core components"}),"\n",(0,r.jsx)(n.li,{children:"Owns the state machine"}),"\n",(0,r.jsx)(n.li,{children:"Handles the main event loop"}),"\n",(0,r.jsx)(n.li,{children:"Manages interruption flow"}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"statemachinets---state-management",children:[(0,r.jsx)(n.code,{children:"StateMachine.ts"})," - State Management"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Clean state transitions without flag hell"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"States:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"enum State {\n  IDLE,          // Waiting for user input\n  LISTENING,     // User is speaking\n  SPEAKING,      // Agent is responding\n  INTERRUPTING,  // Interrupt in progress\n  ERROR          // Error state\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Transitions:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"IDLE \u2192 LISTENING"})," - User starts speaking"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"LISTENING \u2192 SPEAKING"})," - User finishes, agent responds"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SPEAKING \u2192 INTERRUPTING"})," - User interrupts"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"INTERRUPTING \u2192 LISTENING"})," - Ready for new input"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No conflicting flags"}),"\n",(0,r.jsx)(n.li,{children:"Clear state transitions"}),"\n",(0,r.jsx)(n.li,{children:"Easy to debug"}),"\n",(0,r.jsx)(n.li,{children:"Prevents race conditions"}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"audiocontrollerts---audio-gate",children:[(0,r.jsx)(n.code,{children:"AudioController.ts"})," - Audio Gate"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Instant control over audio flow to Twilio"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Features:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"open()"})," - Allow audio to flow"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"close()"})," - Stop audio immediately"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"shouldSendAudio()"})," - Check if audio should be sent"]}),"\n",(0,r.jsx)(n.li,{children:"Gate state managed by state machine"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How It Works:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"TTS generates audio continuously"}),"\n",(0,r.jsx)(n.li,{children:"AudioController decides what gets sent to Twilio"}),"\n",(0,r.jsx)(n.li,{children:"Closing the gate = instant silence"}),"\n",(0,r.jsx)(n.li,{children:"No more waiting for buffers to clear"}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"interruptiondetectorts---smart-detection",children:[(0,r.jsx)(n.code,{children:"InterruptionDetector.ts"})," - Smart Detection"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Detect user interruptions with adaptive thresholds"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Features:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Adaptive noise baseline"})," - Learns ambient noise over time"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Energy-based detection"})," - Calculates audio energy from mulaw samples"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Configurable sensitivity"})," - Adjustable threshold multiplier"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Debouncing"})," - Prevents rapid re-triggers"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Methods:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"processAudioChunk(audio)"})," - Analyze incoming audio"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"updateBaseline(energy)"})," - Update rolling noise average"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"isInterruption()"})," - Detect if current audio is interruption"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Algorithm:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"energy = calculateEnergy(audioChunk)\nif (state === SPEAKING && energy > baseline * threshold) {\n  return INTERRUPT\n}\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"conversationmanagerts---context-management",children:[(0,r.jsx)(n.code,{children:"ConversationManager.ts"})," - Context Management"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Manage conversation history and handle truncation on interrupts"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Methods:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"addMessage(role, content)"})," - Add to conversation history"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getHistory()"})," - Retrieve full conversation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"truncateToPartial(partialText)"})," - Handle interrupted responses"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"clear()"})," - Reset conversation"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Features:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Maintains typed message history"}),"\n",(0,r.jsx)(n.li,{children:"Handles partial message truncation on interrupt"}),"\n",(0,r.jsx)(n.li,{children:"Provides context for LLM"}),"\n",(0,r.jsx)(n.li,{children:"Memory efficient"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"managers",children:(0,r.jsx)(n.strong,{children:"Managers"})}),"\n",(0,r.jsxs)(n.h4,{id:"sessionmanagerts---session-lifecycle",children:[(0,r.jsx)(n.code,{children:"SessionManager.ts"})," - Session Lifecycle"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Manage individual call sessions"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Methods:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"createSession(streamSid, ws)"})," - Initialize new session"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getSession(streamSid)"})," - Retrieve session"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"deleteSession(streamSid)"})," - Clean up session"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getAllSessions()"})," - Get all active sessions"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Features:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Maps streamSid to VoiceAgent instances"}),"\n",(0,r.jsx)(n.li,{children:"Handles session cleanup"}),"\n",(0,r.jsx)(n.li,{children:"Manages multiple concurrent calls"}),"\n",(0,r.jsx)(n.li,{children:"Prevents memory leaks"}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"deepgrammanagerts---deepgram-integration",children:[(0,r.jsx)(n.code,{children:"DeepgramManager.ts"})," - Deepgram Integration"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Manage Deepgram STT and TTS connections with pooling"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Features:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Connection pooling"})," - Reuse connections, avoid rate limits"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"STT Management"})," - Speech-to-Text with event handlers"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"TTS Management"})," - Text-to-Speech streaming"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Error handling"})," - Automatic reconnection on failures"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Methods:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"createSTTConnection()"})," - Create/get pooled STT connection"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"createTTSConnection()"})," - Create/get pooled TTS connection"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"setupSTTHandlers(onTranscript)"})," - Configure STT events"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"setupTTSHandlers(onAudio)"})," - Configure TTS events"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"closeConnections()"})," - Clean shutdown"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No more Deepgram rate limit issues"}),"\n",(0,r.jsx)(n.li,{children:"Efficient resource usage"}),"\n",(0,r.jsx)(n.li,{children:"Handles reconnection automatically"}),"\n",(0,r.jsx)(n.li,{children:"Clean event-driven API"}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"llmmanagerts---claude-integration",children:[(0,r.jsx)(n.code,{children:"LLMManager.ts"})," - Claude Integration"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Manage Claude AI streaming with proper abort handling"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Features:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Configurable model (Claude 3.5 Haiku)"}),"\n",(0,r.jsx)(n.li,{children:"System prompt management"}),"\n",(0,r.jsx)(n.li,{children:"Streaming text responses"}),"\n",(0,r.jsx)(n.li,{children:"Abort signal support"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Methods:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"createAgent(abortSignal)"})," - Create configured Claude agent"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"streamResponse(conversation, onChunk, onComplete)"})," - Stream LLM response"]}),"\n",(0,r.jsx)(n.li,{children:"Handles AbortError gracefully"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'model: "claude-3-5-haiku-latest"\nsystem: Custom prompt for Jordan (personal assistant)\nstopWhen: stepCountIs(20)\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"handlers",children:(0,r.jsx)(n.strong,{children:"Handlers"})}),"\n",(0,r.jsxs)(n.h4,{id:"twiliohandlerts---twilio-integration",children:[(0,r.jsx)(n.code,{children:"TwilioHandler.ts"})," - Twilio Integration"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Handle Twilio WebSocket messages and route to VoiceAgent"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Event Handlers:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"handleStart()"})," - New call initiated"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"handleMedia()"})," - Audio data received"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"handleStop()"})," - Call ended"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"handleMark()"})," - Track message received"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flow:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Twilio WebSocket \u2192 TwilioHandler \u2192 VoiceAgent \u2192 Processing\n                \u2190 TwilioHandler \u2190 AudioController \u2190 Audio output\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"main-entry-point",children:(0,r.jsx)(n.strong,{children:"Main Entry Point"})}),"\n",(0,r.jsxs)(n.h4,{id:"indexts---bun-server",children:[(0,r.jsx)(n.code,{children:"index.ts"})," - Bun Server"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," HTTP/WebSocket server setup"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Routes:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /api/calls/:number"})," - Initiate outbound call"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /api/twilio-gateway"})," - TwiML for call routing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"WS /twilio-ws"})," - WebSocket for audio streaming"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Features:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Clean route handling"}),"\n",(0,r.jsx)(n.li,{children:"Environment variable validation"}),"\n",(0,r.jsx)(n.li,{children:"WebSocket upgrade handling"}),"\n",(0,r.jsx)(n.li,{children:"Delegates to TwilioHandler"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-data-flow",children:"\ud83d\udd04 Data Flow"}),"\n",(0,r.jsx)(n.h3,{id:"normal-conversation-flow",children:"Normal Conversation Flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. User speaks\n   \u2193\n2. Twilio \u2192 handleMedia() \u2192 audio chunks\n   \u2193\n3. VoiceAgent.handleIncomingAudio()\n   \u2193\n4. Deepgram STT \u2192 transcript\n   \u2193\n5. VoiceAgent.handleTranscript()\n   \u2193\n6. StateMachine: LISTENING \u2192 SPEAKING\n   \u2193\n7. LLMManager.streamResponse()\n   \u2193\n8. AudioController.open()\n   \u2193\n9. Deepgram TTS \u2192 audio\n   \u2193\n10. AudioController \u2192 Twilio\n   \u2193\n11. User hears response\n"})}),"\n",(0,r.jsx)(n.h3,{id:"interruption-flow",children:"Interruption Flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. User speaks while agent is speaking\n   \u2193\n2. VoiceAgent.handleIncomingAudio()\n   \u2193\n3. InterruptionDetector.isInterruption() = true\n   \u2193\n4. VoiceAgent.interrupt()\n   \u2193\n5. StateMachine: SPEAKING \u2192 INTERRUPTING\n   \u2193\n6. AudioController.close() - INSTANT silence\n   \u2193\n7. LLMManager aborts stream\n   \u2193\n8. ConversationManager.truncateToPartial()\n   \u2193\n9. Send Twilio clear commands\n   \u2193\n10. StateMachine: INTERRUPTING \u2192 LISTENING\n   \u2193\n11. Ready for new user input\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-key-architectural-decisions",children:"\ud83c\udfaf Key Architectural Decisions"}),"\n",(0,r.jsxs)(n.h3,{id:"1-state-machine-over-flags",children:["1. ",(0,r.jsx)(n.strong,{children:"State Machine Over Flags"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Before:"})," Multiple boolean flags (",(0,r.jsx)(n.code,{children:"isStreaming"}),", ",(0,r.jsx)(n.code,{children:"isProcessingInterrupt"}),", ",(0,r.jsx)(n.code,{children:"audioGateOpen"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"After:"})," Single state enum with clear transitions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Benefit:"})," No conflicting states, easier to debug"]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"2-audio-gate-pattern",children:["2. ",(0,r.jsx)(n.strong,{children:"Audio Gate Pattern"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Before:"})," Try to clear Twilio buffers after audio sent"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"After:"})," Control audio at the source before sending"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Benefit:"})," Instant interruption response"]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"3-connection-pooling",children:["3. ",(0,r.jsx)(n.strong,{children:"Connection Pooling"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Before:"})," Recreate Deepgram connections on every interrupt"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"After:"})," Reuse connections throughout call lifecycle"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Benefit:"})," No rate limit issues, better performance"]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"4-event-driven-architecture",children:["4. ",(0,r.jsx)(n.strong,{children:"Event-Driven Architecture"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Before:"})," Direct method calls and flag checking"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"After:"})," Components communicate via events and state changes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Benefit:"})," Loose coupling, easier to test and extend"]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"5-separation-of-concerns",children:["5. ",(0,r.jsx)(n.strong,{children:"Separation of Concerns"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Before:"})," Everything mixed together"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"After:"})," Each component has a single, clear responsibility"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Benefit:"})," Maintainable, testable, scalable"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-performance-optimizations",children:"\ud83d\ude80 Performance Optimizations"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Adaptive Thresholds"})," - Learns environment noise automatically"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Connection Reuse"})," - No overhead from recreating connections"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Debouncing"})," - Prevents rapid re-triggers of interruptions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Efficient State Checks"})," - Single state variable vs multiple flags"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Minimal Memory Footprint"})," - Clean session cleanup"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"\ufe0f-future-extensibility",children:"\ud83d\udee0\ufe0f Future Extensibility"}),"\n",(0,r.jsx)(n.p,{children:"Easy to add:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Multiple LLM providers (swap LLMManager)"}),"\n",(0,r.jsx)(n.li,{children:"Different TTS voices (configure DeepgramManager)"}),"\n",(0,r.jsx)(n.li,{children:"Custom interruption strategies (modify InterruptionDetector)"}),"\n",(0,r.jsx)(n.li,{children:"Advanced conversation features (extend ConversationManager)"}),"\n",(0,r.jsx)(n.li,{children:"Telemetry and monitoring (add observers to state machine)"}),"\n",(0,r.jsx)(n.li,{children:"Multi-language support (configure LLM system prompt)"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-configuration",children:"\ud83d\udcdd Configuration"}),"\n",(0,r.jsx)(n.p,{children:"All configuration lives in:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Environment variables (",(0,r.jsx)(n.code,{children:".env"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"Manager constructors (easy to customize)"}),"\n",(0,r.jsx)(n.li,{children:"No scattered config across codebase"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-testing-strategy",children:"\ud83e\uddea Testing Strategy"}),"\n",(0,r.jsx)(n.p,{children:"Each component can be tested in isolation:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"StateMachine"})," - Test state transitions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"AudioController"})," - Test gate open/close logic"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"InterruptionDetector"})," - Test detection algorithm"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ConversationManager"})," - Test history management"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Managers"})," - Mock external services"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:"This architecture is production-ready, maintainable, and built to handle the complex real-time requirements of voice AI conversations."})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);