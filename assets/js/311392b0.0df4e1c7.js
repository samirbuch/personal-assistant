"use strict";(globalThis.webpackChunkpersonal_assistant_docs=globalThis.webpackChunkpersonal_assistant_docs||[]).push([[8260],{28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>l});var s=t(96540);const i={},a=s.createContext(i);function r(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:n},e.children)}},63393:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"architecture-diagram","title":"Architecture Diagram","description":"Class diagram showing the flow of information in the Personal Assistant Voice Agent system","source":"@site/docs/architecture-diagram.md","sourceDirName":".","slug":"/architecture-diagram","permalink":"/personal-assistant/docs/architecture-diagram","draft":false,"unlisted":false,"editUrl":"https://github.com/samirbuch/personal-assistant/edit/main/docs/docs/architecture-diagram.md","tags":[],"version":"current","lastUpdatedBy":"bdotsamir","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Architecture Diagram","description":"Class diagram showing the flow of information in the Personal Assistant Voice Agent system"},"sidebar":"docsSidebar","next":{"title":"System Design","permalink":"/personal-assistant/docs/system-design"}}');var i=t(74848),a=t(28453);const r={sidebar_position:2,title:"Architecture Diagram",description:"Class diagram showing the flow of information in the Personal Assistant Voice Agent system"},l="Architecture Diagram",o={},c=[{value:"Information Flow",id:"information-flow",level:2},{value:"Inbound Call Flow",id:"inbound-call-flow",level:3},{value:"Outbound Call Flow",id:"outbound-call-flow",level:3},{value:"State Management",id:"state-management",level:3},{value:"Conference/Transfer Flow",id:"conferencetransfer-flow",level:3},{value:"Key Design Patterns",id:"key-design-patterns",level:2},{value:"Component Separation",id:"component-separation",level:3},{value:"Single Responsibility",id:"single-responsibility",level:3},{value:"Event-Driven Architecture",id:"event-driven-architecture",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"architecture-diagram",children:"Architecture Diagram"})}),"\n",(0,i.jsx)(n.p,{children:"This diagram illustrates the core architecture and information flow of the Personal Assistant Voice Agent system."}),"\n",(0,i.jsx)(n.mermaid,{value:'---\nconfig: \n  layout: elk\n---\nclassDiagram\n    %% Entry Point\n    class Server {\n        +PORT\n        +twilioClient\n        +appointmentListener\n        +handleStart()\n        +handleMedia()\n        +handleStop()\n        +initiateCall()\n    }\n\n    %% Handlers\n    class TwilioHandler {\n        +handleStart()\n        +handleMedia()\n        +handleStop()\n        +initiateConference()\n        +getSessionManager()\n    }\n\n    %% Managers\n    class SessionManager {\n        -agents: Map~string, VoiceAgent~\n        +create(streamSid, agent)\n        +getAgent(streamSid)\n        +delete(streamSid)\n        +getAllAgents()\n    }\n\n    class DatabaseAppointmentListener {\n        -channel: RealtimeChannel\n        +on(event, callback)\n        -handleInsert()\n        -handleUpdate()\n    }\n\n    class DeepgramManager {\n        +createSTT()\n        +createTTS()\n        +setupSTTHandlers()\n        +setupTTSHandlers()\n    }\n\n    class LLMManager {\n        +createLLMAgent(voiceAgent, userContext)\n        +tools: getCalendarAvailability\n        +tools: getCalendarEvents\n        +tools: transferToHuman\n        +tools: updateAppointmentNotes\n    }\n\n    class OutlookManager {\n        -msalClient\n        +getAvailableSlots(start, end, minDuration)\n        +getEvents(start, end)\n        +createEvent()\n    }\n\n    class ConferenceManager {\n        -twilioClient\n        -conferences: Map\n        +createConferenceAndAddOwner(callSid, streamSid)\n        +getConferenceState()\n        +endConference()\n    }\n\n    %% Core Components\n    class VoiceAgent {\n        -streamSid: string\n        -callSid: string\n        -stateMachine: VoiceAgentStateMachine\n        -audio: AudioController\n        -conversation: ConversationManager\n        -interruption: InterruptionDetector\n        -stt: LiveClient\n        -tts: SpeakLiveClient\n        -agent: Agent\n        +initialize()\n        +handleIncomingAudio(mulawBase64)\n        +handleTranscript(transcript)\n        +handleTTSAudio(audioBase64)\n        +processUserInput()\n        +speak(text)\n        +cleanup()\n    }\n\n    class VoiceAgentStateMachine {\n        -currentState: AgentState\n        -transitions: StateTransition[]\n        +getState()\n        +transition(to, reason)\n        +canTransitionTo(newState)\n        +onStateChange(listener)\n    }\n\n    class AudioController {\n        -enabled: boolean\n        -ws: WebSocket\n        -streamSid: string\n        +enable()\n        +disable()\n        +isEnabled()\n        +sendAudio(audioBase64)\n        +clearBuffer()\n        +stopImmediately()\n    }\n\n    class ConversationManager {\n        -messages: ModelMessage[]\n        -currentAssistantMessage: string\n        -conferenceMode: boolean\n        +addUserMessage(content, speaker)\n        +addAssistantMessage(content)\n        +appendAssistantDelta(delta)\n        +handleInterruption()\n        +getMessages()\n        +enableConferenceMode()\n    }\n\n    class InterruptionDetector {\n        -lastDetectionTime: number\n        -detectionCount: number\n        +detectActivity(mulawBase64)\n        +shouldInterrupt(mulawBase64)\n    }\n\n    %% External Services\n    class Deepgram {\n        <<external>>\n        +LiveClient (STT)\n        +SpeakLiveClient (TTS)\n    }\n\n    class Twilio {\n        <<external>>\n        +WebSocket\n        +Calls API\n        +Conference API\n    }\n\n    class Claude {\n        <<external>>\n        +AI Agent\n        +Tool Calling\n    }\n\n    class Supabase {\n        <<external>>\n        +Database\n        +Realtime Subscriptions\n    }\n\n    class Outlook {\n        <<external>>\n        +Calendar API\n        +Events API\n    }\n\n    %% Relationships - Entry & Setup\n    Server --\x3e TwilioHandler : uses\n    Server --\x3e DatabaseAppointmentListener : listens to\n    TwilioHandler --\x3e SessionManager : manages sessions\n    TwilioHandler --\x3e DeepgramManager : creates STT/TTS\n    TwilioHandler --\x3e LLMManager : creates agent\n    TwilioHandler --\x3e VoiceAgent : creates & routes\n\n    %% Relationships - Voice Agent Core\n    VoiceAgent --\x3e VoiceAgentStateMachine : manages state\n    VoiceAgent --\x3e AudioController : controls audio\n    VoiceAgent --\x3e ConversationManager : tracks conversation\n    VoiceAgent --\x3e InterruptionDetector : detects interruptions\n    VoiceAgent --\x3e Deepgram : sends/receives audio\n    VoiceAgent --\x3e Claude : generates responses\n\n    %% Relationships - Managers\n    LLMManager --\x3e OutlookManager : calendar tools\n    LLMManager --\x3e ConferenceManager : transfer tool\n    SessionManager --\x3e VoiceAgent : stores/retrieves\n    DatabaseAppointmentListener --\x3e Supabase : subscribes to\n    OutlookManager --\x3e Outlook : queries calendar\n\n    %% Relationships - External Services\n    DeepgramManager --\x3e Deepgram : creates clients\n    ConferenceManager --\x3e Twilio : manages conferences\n    Server --\x3e Twilio : initiates calls\n    AudioController --\x3e Twilio : sends audio\n\n    %% Data Flow Annotations\n    note for VoiceAgent "Central orchestrator: 1. Receives audio from Twilio, 2. Transcribes via Deepgram STT, 3. Processes with Claude LLM, 4. Synthesizes via Deepgram TTS, 5. Sends audio back to Twilio"\n\n    note for VoiceAgentStateMachine "States: IDLE \u2192 LISTENING \u2192 THINKING \u2192 SPEAKING \u2192  INTERRUPTED"\n\n    note for DatabaseAppointmentListener "Triggers outbound calls when new appointments are created"'}),"\n",(0,i.jsx)(n.h2,{id:"information-flow",children:"Information Flow"}),"\n",(0,i.jsx)(n.h3,{id:"inbound-call-flow",children:"Inbound Call Flow"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Call Initiation"}),": Twilio receives incoming call and opens WebSocket connection"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Session Setup"}),": ",(0,i.jsx)(n.code,{children:"TwilioHandler.handleStart()"})," creates:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Deepgram STT/TTS clients via ",(0,i.jsx)(n.code,{children:"DeepgramManager"})]}),"\n",(0,i.jsxs)(n.li,{children:["LLM Agent with tools via ",(0,i.jsx)(n.code,{children:"LLMManager"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"VoiceAgent"})," instance with all dependencies"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Registration"}),": ",(0,i.jsx)(n.code,{children:"SessionManager"})," stores the VoiceAgent by streamSid"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Audio Loop"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Twilio \u2192 ",(0,i.jsx)(n.code,{children:"VoiceAgent.handleIncomingAudio()"})," \u2192 Deepgram STT"]}),"\n",(0,i.jsxs)(n.li,{children:["Deepgram STT \u2192 ",(0,i.jsx)(n.code,{children:"VoiceAgent.handleTranscript()"})," \u2192 State transition to THINKING"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"VoiceAgent.processUserInput()"})," \u2192 Claude LLM (with calendar tools)"]}),"\n",(0,i.jsxs)(n.li,{children:["LLM response \u2192 ",(0,i.jsx)(n.code,{children:"VoiceAgent.speak()"})," \u2192 Deepgram TTS"]}),"\n",(0,i.jsxs)(n.li,{children:["Deepgram TTS \u2192 ",(0,i.jsx)(n.code,{children:"VoiceAgent.handleTTSAudio()"})," \u2192 AudioController \u2192 Twilio"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"outbound-call-flow",children:"Outbound Call Flow"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Appointment Created"}),": User creates appointment via web frontend"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Database Trigger"}),": Supabase realtime event fires"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Listener Notification"}),": ",(0,i.jsx)(n.code,{children:"DatabaseAppointmentListener"})," receives event"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Call Initiation"}),": Server calls API endpoint ",(0,i.jsx)(n.code,{children:"/api/calls/:number"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Same as Inbound"}),": Once connected, follows same audio loop"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"state-management",children:"State Management"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"VoiceAgentStateMachine"})," enforces valid state transitions:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"IDLE"})," \u2192 ",(0,i.jsx)(n.strong,{children:"LISTENING"}),": Call starts"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"LISTENING"})," \u2192 ",(0,i.jsx)(n.strong,{children:"THINKING"}),": User finishes speaking (transcript received)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"THINKING"})," \u2192 ",(0,i.jsx)(n.strong,{children:"SPEAKING"}),": LLM generates response, TTS begins"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SPEAKING"})," \u2192 ",(0,i.jsx)(n.strong,{children:"INTERRUPTED"}),": User speaks during agent speech"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SPEAKING"})," \u2192 ",(0,i.jsx)(n.strong,{children:"LISTENING"}),": Agent finishes speaking"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"INTERRUPTED"})," \u2192 ",(0,i.jsx)(n.strong,{children:"LISTENING"}),": Interrupt handled, ready for user"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"conferencetransfer-flow",children:"Conference/Transfer Flow"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["User requests human via LLM tool ",(0,i.jsx)(n.code,{children:"transferToHuman()"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ConferenceManager.createConferenceAndAddOwner()"})," is called"]}),"\n",(0,i.jsx)(n.li,{children:"Twilio Conference created and owner is dialed in"}),"\n",(0,i.jsx)(n.li,{children:"Original call moved to conference"}),"\n",(0,i.jsx)(n.li,{children:"AI disconnects, caller and owner continue directly"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"key-design-patterns",children:"Key Design Patterns"}),"\n",(0,i.jsx)(n.h3,{id:"component-separation",children:"Component Separation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Core"}),": Business logic (VoiceAgent, StateMachine, ConversationManager)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Managers"}),": External service integration (Deepgram, LLM, Outlook)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Handlers"}),": Protocol/API handling (TwilioHandler)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Utils"}),": Shared utilities"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"single-responsibility",children:"Single Responsibility"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Each class has one clear purpose"}),"\n",(0,i.jsx)(n.li,{children:"VoiceAgent orchestrates but delegates to specialists"}),"\n",(0,i.jsx)(n.li,{children:"State management separated from audio/conversation logic"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"event-driven-architecture",children:"Event-Driven Architecture"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Database changes trigger appointments via EventEmitter"}),"\n",(0,i.jsx)(n.li,{children:"State transitions notify listeners"}),"\n",(0,i.jsx)(n.li,{children:"Deepgram events drive audio pipeline"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);